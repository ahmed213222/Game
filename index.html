<!DOCTYPE html>

<html lang="ar" dir="rtl">

<head>

ย ย <meta charset="UTF-8">

ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">

ย ย <title>ูุนุจุฉ ููู ุงููุนูููุงุช</title>

ย ย <script src="https://cdn.tailwindcss.com"></script>

ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

ย ย <link rel="preconnect" href="https://fonts.googleapis.com">

ย ย <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

ย ย <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

ย ย <style>

ย ย ย ย body {

ย ย ย ย ย ย font-family: 'Cairo', sans-serif;

ย ย ย ย ย ย overscroll-behavior-y: contain;

ย ย ย ย }

ย ย ย ย @keyframes fadeIn {

ย ย ย ย ย ย from { opacity: 0; transform: translateY(-10px); }

ย ย ย ย ย ย to { opacity: 1; transform: translateY(0); }

ย ย ย ย }

ย ย ย ย .fade-in {

ย ย ย ย ย ย animation: fadeIn 0.5s ease-out forwards;

ย ย ย ย }

ย ย ย ย .option-btn {

ย ย ย ย ย ย transition: all 0.2s ease-in-out;

ย ย ย ย }

ย ย ย ย .option-btn:hover {

ย ย ย ย ย ย transform: translateY(-2px);

ย ย ย ย ย ย box-shadow: 0 4px 12px rgba(0,0,0,0.1);

ย ย ย ย }

ย ย ย ย #timer-bar-inner {

ย ย ย ย ย ย transition: width 1s linear;

ย ย ย ย }

ย ย ย ย /* Toggle Switch */

ย ย ย ย .toggle-checkbox:checked {

ย ย ย ย ย ย right: 0;

ย ย ย ย ย ย border-color: #3b82f6;

ย ย ย ย }

ย ย ย ย .toggle-checkbox:checked + .toggle-label {

ย ย ย ย ย ย background-color: #3b82f6;

ย ย ย ย }

ย ย </style>

</head>

<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">



ย ย <div id="app" class="container mx-auto p-4 max-w-2xl w-full">



ย ย ย ย <!-- ุดุงุดุฉ ุงูุฅุนุฏุงุฏ -->

ย ย ย ย <div id="setup-view" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl fade-in">

ย ย ย ย ย ย <header class="text-center mb-6">

ย ย ย ย ย ย ย ย <h1 class="text-4xl font-bold text-blue-600">ููู ุงููุนูููุงุช</h1>

ย ย ย ย ย ย ย ย <p class="text-gray-500 mt-1">ูุนุจุฉ ุงูุฐูุงุก ูุงููุนุฑูุฉ ุงูุนุงูุฉ</p>

ย ย ย ย ย ย </header>



ย ย ย ย ย ย <div class="mb-6">

ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-3">

ย ย ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold text-gray-700">ุฃุถู ุงููุงุนุจูู</h2>

ย ย ย ย ย ย ย ย ย ย <button id="clear-players-btn" class="text-sm text-red-500 hover:underline">ูุณุญ ูู ุงููุงุนุจูู</button>

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="flex gap-2">

ย ย ย ย ย ย ย ย ย ย <input type="text" id="player-name-input" placeholder="ุฃุฏุฎู ุงุณู ุงููุงุนุจ" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500 transition">

ย ย ย ย ย ย ย ย ย ย <button id="add-player-btn" class="bg-blue-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-600 transition shadow">ุฅุถุงูุฉ</button>

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <ul id="player-list" class="list-none p-0 mt-3 space-y-2"></ul>

ย ย ย ย ย ย </div>

ย ย ย ย ย ยย

ย ย ย ย ย ย <div class="mb-6">

ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold mb-3 text-gray-700">ุงุฎุชุฑ ุฃู ุฃูุดุฆ ุงููุฆุงุช</h2>

ย ย ย ย ย ย ย ย ย<div id="ai-category-creator" class="mb-3">

ย ย ย ย ย ย ย ย ย ย ย<div class="flex gap-2">

ย ย ย ย ย ย ย ย ย ย ย ย ย<input type="text" id="custom-category-input" placeholder="ุงูุชุจ ููุถูุนูุง (ูุซู: ุชุงุฑูุฎ ุงูุฃูุฏูุณ)" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500 transition">

ย ย ย ย ย ย ย ย ย ย ย ย ย<button id="add-category-btn" class="bg-blue-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-600 transition shadow">โจ ุฃุถู</button>

ย ย ย ย ย ย ย ย ย ย ย</div>

ย ย ย ย ย ย ย ย ย</div>

ย ย ย ย ย ย ย ย ย<div id="category-tags" class="flex flex-wrap gap-2 mb-3">

ย ย ย ย ย ย ย ย ย ย ย<!-- Custom category tags will be added here -->

ย ย ย ย ย ย ย ย ย</div>

ย ย ย ย ย ย ย ย ย<p class="text-sm text-gray-500 mb-3">ุฃู ุงุฎุชุฑ ูู ุงูุงูุชุฑุงุญุงุช:</p>

ย ย ย ย ย ย ย ย ย<div id="category-suggestions" class="flex flex-wrap gap-2">

ย ย ย ย ย ย ย ย ย ย ย<!-- Default category suggestions -->

ย ย ย ย ย ย ย ย ย</div>

ย ย ย ย ย ย </div>

ย ย ย ย ย ยย

ย ย ย ย ย ย <div class="mb-8 p-4 bg-gray-50 border border-gray-200 rounded-lg">

ย ย ย ย ย ย ย ย <div class="flex items-center justify-between">

ย ย ย ย ย ย ย ย ย ย <label for="local-questions-toggle" class="text-lg font-bold text-gray-800">ุงุณุชุฎุฏุงู ุงูุฃุณุฆูุฉ ุงููุญููุฉ ููุท</label>

ย ย ย ย ย ย ย ย ย ย <div class="relative inline-block w-14 mr-2 align-middle select-none transition duration-200 ease-in">

ย ย ย ย ย ย ย ย ย ย ย ย <input type="checkbox" name="local-questions-toggle" id="local-questions-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"/>

ย ย ย ย ย ย ย ย ย ย ย ย <label for="local-questions-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>

ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <p class="text-sm text-gray-500 mt-2">ูุนูู ูุฐุง ุงูุฎูุงุฑ ุฅุฐุง ููุช ูุง ุชุฑูุฏ ุงุณุชุฎุฏุงู ุงูุฅูุชุฑูุช ุฃู ูุงุฌูุช ูุดููุฉ ูู ุงูุงุชุตุงู.</p>

ย ย ย ย ย ย </div>



ย ย ย ย ย ย <button id="start-game-btn" class="w-full bg-teal-500 text-white font-black py-4 px-8 rounded-lg hover:bg-teal-600 transition shadow-lg text-2xl disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>ุงุจุฏุฃ ุงููุนุจุฉ</button>

ย ย ย ย </div>



ย ย ย ย <!-- ุดุงุดุฉ ุชูุฑูุฑ ุงููุงุชู -->

ย ย ย ย <div id="pass-phone-view" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center fade-in">

ย ย ย ย ย ย <h2 id="pass-to-player-name" class="text-3xl font-bold text-gray-800 mb-2"></h2>

ย ย ย ย ย ย <p id="pass-info" class="text-lg text-gray-600 mb-6"></p>

ย ย ย ย ย ย <button id="start-turn-btn" class="w-full bg-teal-500 text-white font-bold py-4 px-8 rounded-lg hover:bg-teal-600 transition shadow-lg text-2xl">ุฃูุง ุฌุงูุฒ!</button>

ย ย ย ย </div>



ย ย ย ย <!-- ุดุงุดุฉ ุงููุนุจ (ุงูุฃุณุฆูุฉ) -->

ย ย ย ย <div id="game-view" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-xl fade-in">

ย ย ย ย ย ย <div class="flex justify-between items-center mb-2 text-gray-600 font-bold">

ย ย ย ย ย ย ย ย <div id="player-turn-name"></div>

ย ย ย ย ย ย ย ย <div id="question-counter"></div>

ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div id="timer-bar" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">

ย ย ย ย ย ย ย ย <div id="timer-bar-inner" class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>

ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="bg-gray-100 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">

ย ย ย ย ย ย ย ย <h2 id="question-text" class="text-2xl text-center font-semibold"></h2>

ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">

ย ย ย ย ย ย ย ย <!-- Options will be injected here -->

ย ย ย ย ย ย </div>

ย ย ย ย </div>



ย ย ย ย <!-- ุดุงุดุฉ ููุงูุฉ ุงูุฌููุฉ / ูุณุฑ ุงูุชุนุงุฏู -->

ย ย ย ย <div id="round-end-view" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center fade-in">

ย ย ย ย ย ย <h2 id="round-end-title" class="text-3xl font-bold text-blue-600 mb-4"></h2>

ย ย ย ย ย ย <p class="text-lg text-gray-600 mb-6">ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ ููุฌููุฉ:</p>

ย ย ย ย ย ย <ul id="round-scores" class="space-y-3 text-lg mb-8">

ย ย ย ย ย ย ย ย <!-- Scores will be injected here -->

ย ย ย ย ย ย </ul>

ย ย ย ย ย ย <button id="next-action-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 transition shadow-lg text-xl"></button>

ย ย ย ย </div>

ย ย ย ยย

ย ย ย ย <!-- ุดุงุดุฉ ุงููุงุฆุฒ ุงูููุงุฆู -->

ย ย ย ย <div id="winner-view" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center fade-in">

ย ย ย ย ย ย <div class="text-amber-400 text-6xl mb-4">๐</div>

ย ย ย ย ย ย <h2 class="text-4xl font-black text-amber-500 mb-2">ุงููุงุฆุฒ ูู!</h2>

ย ย ย ย ย ย <p id="winner-name" class="text-5xl font-bold text-gray-800 mb-6"></p>

ย ย ย ย ย ย <button id="analyze-performance-btn" class="w-full mb-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition">โจ ุชุญููู ุฃุฏุงุฆู</button>

ย ย ย ย ย ย <button id="play-again-btn" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition">ุงูุนุจ ูุฑุฉ ุฃุฎุฑู</button>

ย ย ย ย </div>



ย ย </div>



ย ย <!-- Modal for clearing players -->

ย ย <div id="clear-players-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">

ย ย ย ย <div class="bg-white p-6 rounded-2xl shadow-xl text-center max-w-sm w-full">

ย ย ย ย ย ย <h3 class="text-xl font-bold mb-4">ูุณุญ ุงููุงุนุจูู</h3>

ย ย ย ย ย ย <p class="text-gray-600 mb-6">ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ูุณุญ ูุงุฆูุฉ ุงููุงุนุจูู ุงููุญููุธุฉุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>

ย ย ย ย ย ย <div class="flex justify-center gap-4">

ย ย ย ย ย ย ย ย <button id="cancel-clear-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">ุฅูุบุงุก</button>

ย ย ย ย ย ย ย ย <button id="confirm-clear-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600">ูุนูุ ุงูุณุญ</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>

ย ย </div>

ย ยย

ย ย <!-- Modal for Performance Analysis -->

ย ย <div id="analysis-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">

ย ย ย ย <div class="bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full">

ย ย ย ย ย ย <h3 class="text-2xl font-bold mb-4 text-center text-indigo-600">โจ ุชุญููู ุงูุฃุฏุงุก โจ</h3>

ย ย ย ย ย ย <div id="analysis-content" class="text-gray-700 text-lg leading-relaxed space-y-4 max-h-[60vh] overflow-y-auto p-2">

ย ย ย ย ย ย ย ย <!-- Analysis content will be injected here -->

ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="flex justify-center mt-6">

ย ย ย ย ย ย ย ย <button id="close-analysis-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-8 rounded-lg hover:bg-gray-300">ุฅุบูุงู</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>

ย ย </div>

ย ยย

ย ย <!-- Loading Overlay -->

ย ย <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center p-4 z-50">

ย ย ย ย <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4 animate-spin"></div>

ย ย ย ย <h2 id="loading-text" class="text-center text-white text-xl font-semibold"></h2>

ย ย </div>





ย ย <script>

ย ย ย ย document.addEventListener('DOMContentLoaded', () => {

ย ย ย ย ย ย // --- ุจูู ุงูุฃุณุฆูุฉ ุงููุญูู (ุงุญุชูุงุทู) ---

ย ย ย ย ย ย const QUESTIONS = {

ย ย ย ย ย ย ย ย general: { name: "ูุนูููุงุช ุนุงูุฉ", items: [ { q: "ูุง ูู ุนุงุตูุฉ ูุตุฑุ", o: ["ุงููุงูุฑุฉ", "ุงูุฅุณููุฏุฑูุฉ", "ุงูุฌูุฒุฉ", "ุงูุฃูุตุฑ"], a: "ุงููุงูุฑุฉ" }, { q: "ูู ุฑุณู ุงููููุงููุฒุงุ", o: ["ูุงู ุฌูุฎ", "ุจููุงุณู", "ููููุงุฑุฏู ุฏุงููุดู", "ูุงููู ุฃูุฌูู"], a: "ููููุงุฑุฏู ุฏุงููุดู" }, { q: "ูุง ูู ุงูุนููุฉ ุงูุฑุณููุฉ ูููุงุจุงูุ", o: ["ุงูููุงู", "ุงูููู", "ุงูุฏููุงุฑ", "ุงููู"], a: "ุงููู" }, { q: "ูู ุฃู ุฑูุงุถุฉ ููุนุฑู ูุญูุฏ ุนูู ููุงูุ", o: ["ูุฑุฉ ุงููุฏู", "ุงูููุงููุฉ", "ูุฑุฉ ุงูุณูุฉ", "ุงูุชูุณ"], a: "ุงูููุงููุฉ" }, ] },

ย ย ย ย ย ย ย ย science: { name: "ุนููู ูุชูููููุฌูุง", items: [ { q: "ูู ุนุฏุฏ ูุงุฑุงุช ุงูุนุงููุ", o: ["5", "6", "7", "8"], a: "7" }, { q: "ูุง ูู ุฃูุจุฑ ูููุจ ูู ุงููุฌููุนุฉ ุงูุดูุณูุฉุ", o: ["ุงูุฃุฑุถ", "ุงููุฑูุฎ", "ุงููุดุชุฑู", "ุฒุญู"], a: "ุงููุดุชุฑู" }, { q: "ูุง ูู ุงูุฑูุฒ ุงูููููุงุฆู ูููุงุกุ", o: ["H2O", "CO2", "O2", "NaCl"], a: "H2O" }, ] },

ย ย ย ย ย ย ย ย history: { name: "ุชุงุฑูุฎ ูุฌุบุฑุงููุง", items: [ { q: "ูู ูู ุฃูู ุฅูุณุงู ูุดู ุนูู ุณุทุญ ุงูููุฑุ", o: ["ุจุงุฒ ุฃูุฏุฑูู", "ููุฑู ุฌุงุฌุงุฑูู", "ููู ุฃุฑูุณุชุฑููุฌ", "ูุงููู ูููููุฒ"], a: "ููู ุฃุฑูุณุชุฑููุฌ" }, { q: "ูุง ูู ุฃุทูู ููุฑ ูู ุงูุนุงููุ", o: ["ุงูุฃูุงุฒูู", "ุงูููู", "ุงููุณูุณูุจู", "ุงููุงูุบุชุณู"], a: "ุงูููู" }, ] },

ย ย ย ย ย ย ย ย islamic: { name: "ุฅุณูุงููุงุช", items: [ { q: "ูุง ูู ุฃูู ุณูุฑุฉ ูุฒูุช ูู ุงููุฑุขู ุงููุฑูู ูุงููุฉุ", o: ["ุงูุนูู", "ุงููุงุชุญุฉ", "ุงูุฅุฎูุงุต", "ุงูููุซุฑ"], a: "ุงููุงุชุญุฉ" }, { q: "ูู ูู ุงูุตุญุงุจู ุงูุฐู ููุจ ุจู 'ุณูู ุงููู ุงููุณููู'ุ", o: ["ุนูุฑ ุจู ุงูุฎุทุงุจ", "ุนูู ุจู ุฃุจู ุทุงูุจ", "ุฎุงูุฏ ุจู ุงููููุฏ", "ุฃุจู ุจูุฑ ุงูุตุฏูู"], a: "ุฎุงูุฏ ุจู ุงููููุฏ" }, ] },

ย ย ย ย ย ย ย ย hard: { name: "ุฃุณุฆูุฉ ุตุนุจุฉ", items: [ { q: "ูู ุฃู ุนุงู ุงูุชูุช ุงูุญุฑุจ ุงูุนุงูููุฉ ุงูุซุงููุฉุ", o: ["1943", "1945", "1947", "1950"], a: "1945" }, { q: "ูุง ูู ุงูุนูุตุฑ ุงูุฐู ููุชูู ุงูุฑูุฒ ุงูููููุงุฆู 'Au'ุ", o: ["ุงููุถุฉ", "ุงูุฐูุจ", "ุงููุญุงุณ", "ุงูุฃููููููู"], a: "ุงูุฐูุจ" }, ] }

ย ย ย ย ย ย };

ย ย ย ย ย ย const QUESTION_TIME = 15;



ย ย ย ย ย ย // --- ูุชุบูุฑุงุช ุงูุญุงูุฉ ---

ย ย ย ย ย ย let gameState = {};

ย ย ย ย ย ย let timerInterval;



ย ย ย ย ย ย // --- ุงููุคุซุฑุงุช ุงูุตูุชูุฉ ---

ย ย ย ย ย ย let sounds = {};

ย ย ย ย ย ย let audioReady = false;



ย ย ย ย ย ย function setupAudio() {

ย ย ย ย ย ย ย ย sounds.tick = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();

ย ย ย ย ย ย ย ย sounds.timeUp = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();

ย ย ย ย ย ย ย ย sounds.click = new Tone.MembraneSynth().toDestination();

ย ย ย ย ย ย ย ย sounds.nextPlayer = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();

ย ย ย ย ย ย ย ย audioReady = true;

ย ย ย ย ย ย }



ย ย ย ย ย ย // --- ุนูุงุตุฑ ุงููุงุฌูุฉ ---

ย ย ย ย ย ย const views = { setup: document.getElementById('setup-view'), passPhone: document.getElementById('pass-phone-view'), game: document.getElementById('game-view'), roundEnd: document.getElementById('round-end-view'), winner: document.getElementById('winner-view') };

ย ย ย ย ย ย const playerNameInput = document.getElementById('player-name-input');

ย ย ย ย ย ย const addPlayerBtn = document.getElementById('add-player-btn');

ย ย ย ย ย ย const playerList = document.getElementById('player-list');

ย ย ย ย ย ย const categorySuggestions = document.getElementById('category-suggestions');

ย ย ย ย ย ย const customCategoryInput = document.getElementById('custom-category-input');

ย ย ย ย ย ย const addCategoryBtn = document.getElementById('add-category-btn');

ย ย ย ย ย ย const categoryTags = document.getElementById('category-tags');

ย ย ย ย ย ย const startGameBtn = document.getElementById('start-game-btn');

ย ย ย ย ย ย const passToPlayerName = document.getElementById('pass-to-player-name');

ย ย ย ย ย ย const passInfo = document.getElementById('pass-info');

ย ย ย ย ย ย const startTurnBtn = document.getElementById('start-turn-btn');

ย ย ย ย ย ย const playerTurnName = document.getElementById('player-turn-name');

ย ย ย ย ย ย const questionCounter = document.getElementById('question-counter');

ย ย ย ย ย ย const timerBarInner = document.getElementById('timer-bar-inner');

ย ย ย ย ย ย const questionText = document.getElementById('question-text');

ย ย ย ย ย ย const optionsContainer = document.getElementById('options-container');

ย ย ย ย ย ย const roundEndTitle = document.getElementById('round-end-title');

ย ย ย ย ย ย const roundScores = document.getElementById('round-scores');

ย ย ย ย ย ย const nextActionBtn = document.getElementById('next-action-btn');

ย ย ย ย ย ย const winnerName = document.getElementById('winner-name');

ย ย ย ย ย ย const playAgainBtn = document.getElementById('play-again-btn');

ย ย ย ย ย ย const clearPlayersModal = document.getElementById('clear-players-modal');

ย ย ย ย ย ย const clearPlayersBtn = document.getElementById('clear-players-btn');

ย ย ย ย ย ย const cancelClearBtn = document.getElementById('cancel-clear-btn');

ย ย ย ย ย ย const confirmClearBtn = document.getElementById('confirm-clear-btn');

ย ย ย ย ย ย const localQuestionsToggle = document.getElementById('local-questions-toggle');

ย ย ย ย ย ย const loadingOverlay = document.getElementById('loading-overlay');

ย ย ย ย ย ย const loadingText = document.getElementById('loading-text');

ย ย ย ย ย ย const analyzePerformanceBtn = document.getElementById('analyze-performance-btn');

ย ย ย ย ย ย const analysisModal = document.getElementById('analysis-modal');

ย ย ย ย ย ย const analysisContent = document.getElementById('analysis-content');

ย ย ย ย ย ย const closeAnalysisBtn = document.getElementById('close-analysis-btn');



ย ย ย ย ย ย function init() {

ย ย ย ย ย ย ย ย gameState = { players: [], activePlayers: [], selectedCategories: [], questionPool: [], turnIndex: 0, questionsPerRound: 10, isTieBreaker: false, };

ย ย ย ย ย ย ย ย loadPlayersFromStorage();

ย ย ย ย ย ย ย ย renderPlayerList();

ย ย ย ย ย ย ย ย renderCategorySuggestions();

ย ย ย ย ย ย ย ย renderCategoryTags();

ย ย ย ย ย ย ย ย showView('setup');

ย ย ย ย ย ย }



ย ย ย ย ย ย function showView(viewName) {

ย ย ย ย ย ย ย ย Object.values(views).forEach(view => view.classList.add('hidden'));

ย ย ย ย ย ย ย ย views[viewName].classList.remove('hidden');

ย ย ย ย ย ย }

ย ย ย ย ย ยย

ย ย ย ย ย ย function savePlayersToStorage() {

ย ย ย ย ย ย ย ย const playerNames = gameState.players.map(p => p.name);

ย ย ย ย ย ย ย ย localStorage.setItem('quizMasterPlayers', JSON.stringify(playerNames));

ย ย ย ย ย ย }



ย ย ย ย ย ย function loadPlayersFromStorage() {

ย ย ย ย ย ย ย ย const savedPlayers = localStorage.getItem('quizMasterPlayers');

ย ย ย ย ย ย ย ย if (savedPlayers) {

ย ย ย ย ย ย ย ย ย ย const playerNames = JSON.parse(savedPlayers);

ย ย ย ย ย ย ย ย ย ย gameState.players = playerNames.map(name => ({ name, score: 0, questionsAnswered: 0 }));

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }



ย ย ย ย ย ย function renderPlayerList() {

ย ย ย ย ย ย ย ย playerList.innerHTML = '';

ย ย ย ย ย ย ย ย gameState.players.forEach((player, index) => {

ย ย ย ย ย ย ย ย ย ย const li = document.createElement('li');

ย ย ย ย ย ย ย ย ย ย li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-lg';

ย ย ย ย ย ย ย ย ย ย li.textContent = player.name;

ย ย ย ย ย ย ย ย ย ย const removeBtn = document.createElement('button');

ย ย ย ย ย ย ย ย ย ย removeBtn.textContent = 'ร';

ย ย ย ย ย ย ย ย ย ย removeBtn.className = 'text-red-500 font-bold text-2xl hover:text-red-700';

ย ย ย ย ย ย ย ย ย ย removeBtn.onclick = () => removePlayer(index);

ย ย ย ย ย ย ย ย ย ย li.appendChild(removeBtn);

ย ย ย ย ย ย ย ย ย ย playerList.appendChild(li);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย validateSetup();

ย ย ย ย ย ย }

ย ย ย ย ย ยย

ย ย ย ย ย ย function renderCategorySuggestions() {

ย ย ย ย ย ย ย ย categorySuggestions.innerHTML = '';

ย ย ย ย ย ย ย ย Object.values(QUESTIONS).forEach(cat => {

ย ย ย ย ย ย ย ย ย ย if (cat.name === 'ุฃุณุฆูุฉ ุตุนุจุฉ') return;

ย ย ย ย ย ย ย ย ย ย const button = document.createElement('button');

ย ย ย ย ย ย ย ย ย ย button.textContent = cat.name;

ย ย ย ย ย ย ย ย ย ย button.className = 'bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-300';

ย ย ย ย ย ย ย ย ย ย button.onclick = () => addCategory(cat.name);

ย ย ย ย ย ย ย ย ย ย categorySuggestions.appendChild(button);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย }



ย ย ย ย ย ย function renderCategoryTags() {

ย ย ย ย ย ย ย ย categoryTags.innerHTML = '';

ย ย ย ย ย ย ย ย gameState.selectedCategories.forEach((cat, index) => {

ย ย ย ย ย ย ย ย ย ย const tag = document.createElement('div');

ย ย ย ย ย ย ย ย ย ย tag.className = 'flex items-center bg-blue-500 text-white text-md font-semibold px-3 py-1 rounded-full';

ย ย ย ย ย ย ย ย ย ย tag.textContent = cat;

ย ย ย ย ย ย ย ย ย ย const removeBtn = document.createElement('button');

ย ย ย ย ย ย ย ย ย ย removeBtn.textContent = 'ร';

ย ย ย ย ย ย ย ย ย ย removeBtn.className = 'text-white font-bold mr-2 text-lg hover:text-blue-200';

ย ย ย ย ย ย ย ย ย ย removeBtn.onclick = () => removeCategory(index);

ย ย ย ย ย ย ย ย ย ย tag.prepend(removeBtn);

ย ย ย ย ย ย ย ย ย ย categoryTags.appendChild(tag);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย validateSetup();

ย ย ย ย ย ย }

ย ย ย ย ย ยย

ย ย ย ย ย ย function addCategory(categoryName) {

ย ย ย ย ย ย ย ย const name = categoryName.trim();

ย ย ย ย ย ย ย ย if (name && !gameState.selectedCategories.includes(name)) {

ย ย ย ย ย ย ย ย ย ย gameState.selectedCategories.push(name);

ย ย ย ย ย ย ย ย ย ย renderCategoryTags();

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย customCategoryInput.value = '';

ย ย ย ย ย ย }

ย ย ย ย ย ยย

ย ย ย ย ย ย function removeCategory(index) {

ย ย ย ย ย ย ย ย gameState.selectedCategories.splice(index, 1);

ย ย ย ย ย ย ย ย renderCategoryTags();

ย ย ย ย ย ย }



ย ย ย ย ย ย function validateSetup() {

ย ย ย ย ย ย ย ย startGameBtn.disabled = !(gameState.players.length >= 1 && gameState.selectedCategories.length > 0);

ย ย ย ย ย ย }



ย ย ย ย ย ย function addPlayer() {

ย ย ย ย ย ย ย ย const name = playerNameInput.value.trim();

ย ย ย ย ย ย ย ย if (name) {

ย ย ย ย ย ย ย ย ย ย if (gameState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {

ย ย ย ย ย ย ย ย ย ย ย ย playerNameInput.value = '';

ย ย ย ย ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย gameState.players.push({ name, score: 0, questionsAnswered: 0 });

ย ย ย ย ย ย ย ย ย ย playerNameInput.value = '';

ย ย ย ย ย ย ย ย ย ย renderPlayerList();

ย ย ย ย ย ย ย ย ย ย savePlayersToStorage();

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย playerNameInput.focus();

ย ย ย ย ย ย }



ย ย ย ย ย ย function removePlayer(index) {

ย ย ย ย ย ย ย ย gameState.players.splice(index, 1);

ย ย ย ย ย ย ย ย renderPlayerList();

ย ย ย ย ย ย ย ย savePlayersToStorage();

ย ย ย ย ย ย }



ย ย ย ย ย ย async function startGame() {

ย ย ย ย ย ย ย ย if (!audioReady) setupAudio();

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย loadingText.textContent = 'ุฌุงุฑู ุชุญุถูุฑ ุงูุฃุณุฆูุฉ...';

ย ย ย ย ย ย ย ย loadingOverlay.classList.remove('hidden');



ย ย ย ย ย ย ย ย let useLocal = localQuestionsToggle.checked;

ย ย ย ย ย ย ย ย let questionsReady = false;



ย ย ย ย ย ย ย ย // **LOGIC CHANGE**: Always try to fetch AI questions unless local is explicitly checked.

ย ย ย ย ย ย ย ย if (!useLocal) {

ย ย ย ย ย ย ย ย ย ย loadingText.textContent = 'ุฌุงุฑู ุฌูุจ ุฃุณุฆูุฉ ุฌุฏูุฏุฉ ูู ุงูุฅูุชุฑูุช...';

ย ย ย ย ย ย ย ย ย ย const success = await fetchAiQuestions();

ย ย ย ย ย ย ย ย ย ย if (success) {

ย ย ย ย ย ย ย ย ย ย ย ย questionsReady = true;

ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย // Fallback to local if AI fetch fails

ย ย ย ย ย ย ย ย ย ย ย ย loadingText.textContent = 'ูุดู ุฌูุจ ุงูุฃุณุฆูุฉุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุฃุณุฆูุฉ ุงููุญููุฉ.';

ย ย ย ย ย ย ย ย ย ย ย ย // Add a small delay so user can read the message

ย ย ย ย ย ย ย ย ย ย ย ย await new Promise(resolve => setTimeout(resolve, 1500));ย

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย // If questions are still not ready (either because local was checked, or AI fetch failed)

ย ย ย ย ย ย ย ย if (!questionsReady) {

ย ย ย ย ย ย ย ย ย ย populateLocalQuestions();

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย loadingOverlay.classList.add('hidden');

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย gameState.activePlayers = [...gameState.players];

ย ย ย ย ย ย ย ย gameState.activePlayers.forEach(p => { p.score = 0; p.questionsAnswered = 0; });

ย ย ย ย ย ย ย ย gameState.isTieBreaker = false;

ย ย ย ย ย ย ย ย gameState.questionsPerRound = 10;

ย ย ย ย ย ย ย ย gameState.turnIndex = 0;

ย ย ย ย ย ย ย ย prepareTurn();

ย ย ย ย ย ย }



ย ย ย ย ย ย function populateLocalQuestions() {

ย ย ย ย ย ย ย ย let basePool = [];

ย ย ย ย ย ย ย ย // Find matching local categories

ย ย ย ย ย ย ย ย gameState.selectedCategories.forEach(catName => {

ย ย ย ย ย ย ย ย ย ย const localCat = Object.values(QUESTIONS).find(c => c.name === catName);

ย ย ย ย ย ย ย ย ย ย if (localCat) {

ย ย ย ย ย ย ย ย ย ย ย ย basePool.push(...localCat.items);

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย // If no local categories match AT ALL, use general as fallback

ย ย ย ย ย ย ย ย if (basePool.length === 0) {

ย ย ย ย ย ย ย ย ย ย basePool.push(...QUESTIONS.general.items);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย gameState.questionPool = [...basePool].sort(() => 0.5 - Math.random());

ย ย ย ย ย ย }



ย ย ย ย ย ย async function fetchAiQuestions() {

ย ย ย ย ย ย ย ย const categoryNames = gameState.selectedCategories.join(', ');

ย ย ย ย ย ย ย ย const prompt = `Generate 20 quiz questions in Arabic about the following topics: ${categoryNames}. Make the questions varied in difficulty. Ensure each question has 4 options and one correct answer. The correct answer must be one of the four options.`;



ย ย ย ย ย ย ย ย const payload = {

ย ย ย ย ย ย ย ย ย ย contents: [{ role: "user", parts: [{ text: prompt }] }],

ย ย ย ย ย ย ย ย ย ย generationConfig: {

ย ย ย ย ย ย ย ย ย ย ย ย responseMimeType: "application/json",

ย ย ย ย ย ย ย ย ย ย ย ย responseSchema: {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย type: "OBJECT",

ย ย ย ย ย ย ย ย ย ย ย ย ย ย properties: {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย questions: {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย type: "ARRAY",

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย description: "A list of quiz questions.",

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย items: {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย type: "OBJECT",

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย properties: {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย q: { type: "STRING", description: "The question text." },

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย o: { type: "ARRAY", description: "An array of 4 possible answers.", items: { type: "STRING" } },

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย a: { type: "STRING", description: "The correct answer, must be one of the options in 'o'." }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย },

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย required: ["q", "o", "a"]

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย },

ย ย ย ย ย ย ย ย ย ย ย ย ย ย required: ["questions"]

ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย ย ย const apiKey = ""; // Left empty for automatic injection

ย ย ย ย ย ย ย ย ย ย const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

ย ย ย ย ย ย ย ย ย ย const response = await fetch(apiUrl, {

ย ย ย ย ย ย ย ย ย ย ย ย method: 'POST',

ย ย ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },

ย ย ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(payload)

ย ย ย ย ย ย ย ย ย ย });



ย ย ย ย ย ย ย ย ย ย if (!response.ok) {

ย ย ย ย ย ย ย ย ย ย ย ย console.error("API response not OK:", response.status, response.statusText);

ย ย ย ย ย ย ย ย ย ย ย ย return false;

ย ย ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย ย ย const result = await response.json();

ย ย ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย ย ย if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {

ย ย ย ย ย ย ย ย ย ย ย ย const jsonText = result.candidates[0].content.parts[0].text;

ย ย ย ย ย ย ย ย ย ย ย ย const parsedJson = JSON.parse(jsonText);

ย ย ย ย ย ย ย ย ย ย ย ย if (parsedJson.questions && parsedJson.questions.length > 0) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย gameState.questionPool = parsedJson.questions.sort(() => 0.5 - Math.random());

ย ย ย ย ย ย ย ย ย ย ย ย ย ย return true;

ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย console.error("Unexpected API response structure:", result);

ย ย ย ย ย ย ย ย ย ย return false;

ย ย ย ย ย ย ย ย } catch (error) {

ย ย ย ย ย ย ย ย ย ย console.error("Error fetching AI questions:", error);

ย ย ย ย ย ย ย ย ย ย return false;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }





ย ย ย ย ย ย function prepareTurn() {

ย ย ย ย ย ย ย ย if (audioReady) sounds.nextPlayer.triggerAttackRelease("C4", "0.2");

ย ย ย ย ย ย ย ย const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];

ย ย ย ย ย ย ย ย passToPlayerName.textContent = `ุฏูุฑ ${currentPlayer.name}`;

ย ย ย ย ย ย ย ย passInfo.textContent = gameState.isTieBreaker ? `ุงุณุชุนุฏ ูุณุคุงู ูุณุฑ ุงูุชุนุงุฏู!` : `ุงุณุชุนุฏ ูุณุคุงูู ุฑูู ${currentPlayer.questionsAnswered + 1}`;

ย ย ย ย ย ย ย ย showView('passPhone');

ย ย ย ย ย ย }



ย ย ย ย ย ย function startTurn() {

ย ย ย ย ย ย ย ย displayQuestion();

ย ย ย ย ย ย ย ย showView('game');

ย ย ย ย ย ย }



ย ย ย ย ย ย function displayQuestion() {

ย ย ย ย ย ย ย ย // **LOGIC CHANGE**: If the pool is empty mid-game, try fetching more before defaulting to local.

ย ย ย ย ย ย ย ย if (gameState.questionPool.length === 0) {

ย ย ย ย ย ย ย ย ย ย ย// Simple fallback for mid-game depletion. A more robust solution could fetch more AI questions.

ย ย ย ย ย ย ย ย ย ย populateLocalQuestions();ย

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const question = gameState.isTieBreaker ? [...QUESTIONS.hard.items].sort(() => 0.5 - Math.random())[0] : gameState.questionPool.pop();

ย ย ย ย ย ย ย ย gameState.currentQuestion = question;

ย ย ย ย ย ย ย ย const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];

ย ย ย ย ย ย ย ย playerTurnName.textContent = currentPlayer.name;

ย ย ย ย ย ย ย ย questionCounter.textContent = `ุงูุณุคุงู ${currentPlayer.questionsAnswered + 1} / ${gameState.questionsPerRound}`;

ย ย ย ย ย ย ย ย questionText.textContent = question.q;

ย ย ย ย ย ย ย ย optionsContainer.innerHTML = '';

ย ย ย ย ย ย ย ย const shuffledOptions = [...question.o].sort(() => 0.5 - Math.random());

ย ย ย ย ย ย ย ย shuffledOptions.forEach(option => {

ย ย ย ย ย ย ย ย ย ย const button = document.createElement('button');

ย ย ย ย ย ย ย ย ย ย button.textContent = option;

ย ย ย ย ย ย ย ย ย ย button.className = 'option-btn w-full text-lg font-semibold p-4 border-2 border-gray-300 rounded-lg bg-white hover:bg-gray-100';

ย ย ย ย ย ย ย ย ย ย button.onclick = () => handleAnswer(option);

ย ย ย ย ย ย ย ย ย ย optionsContainer.appendChild(button);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย startTimer();

ย ย ย ย ย ย }



ย ย ย ย ย ย function startTimer() {

ย ย ย ย ย ย ย ย let timeLeft = QUESTION_TIME;

ย ย ย ย ย ย ย ย timerBarInner.style.width = '100%';

ย ย ย ย ย ย ย ย timerBarInner.classList.remove('bg-red-500');

ย ย ย ย ย ย ย ย timerBarInner.classList.add('bg-blue-600');



ย ย ย ย ย ย ย ย timerInterval = setInterval(() => {

ย ย ย ย ย ย ย ย ย ย timeLeft--;

ย ย ย ย ย ย ย ย ย ย const percentage = (timeLeft / QUESTION_TIME) * 100;

ย ย ย ย ย ย ย ย ย ย timerBarInner.style.width = `${percentage}%`;



ย ย ย ย ย ย ย ย ย ย if (timeLeft <= 5) {

ย ย ย ย ย ย ย ย ย ย ย ย timerBarInner.classList.remove('bg-blue-600');

ย ย ย ย ย ย ย ย ย ย ย ย timerBarInner.classList.add('bg-red-500');

ย ย ย ย ย ย ย ย ย ย ย ย if (audioReady) sounds.tick.triggerAttackRelease("C5", "0.1");

ย ย ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย ย ย if (timeLeft <= 0) {

ย ย ย ย ย ย ย ย ย ย ย ย handleTimeUp();

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย }, 1000);

ย ย ย ย ย ย }



ย ย ย ย ย ย function stopTimer() {

ย ย ย ย ย ย ย ย clearInterval(timerInterval);

ย ย ย ย ย ย }



ย ย ย ย ย ย function handleAnswer(selectedOption) {

ย ย ย ย ย ย ย ย stopTimer();

ย ย ย ย ย ย ย ย if (audioReady) sounds.click.triggerAttackRelease("C3", "0.1");

ย ย ย ย ย ย ย ย const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];

ย ย ย ย ย ย ย ย if(currentPlayer) {

ย ย ย ย ย ย ย ย ย ย const correctAnswer = gameState.currentQuestion.a;

ย ย ย ย ย ย ย ย ย ย if (selectedOption === correctAnswer) {

ย ย ย ย ย ย ย ย ย ย ย ย currentPlayer.score++;

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย currentPlayer.questionsAnswered++;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย moveToNextTurn();

ย ย ย ย ย ย }



ย ย ย ย ย ย function handleTimeUp() {

ย ย ย ย ย ย ย ย stopTimer();

ย ย ย ย ย ย ย ย if (views.game.classList.contains('hidden')) { return; }

ย ย ย ย ย ย ย ย if (audioReady) sounds.timeUp.triggerAttackRelease("A3", "0.3");

ย ย ย ย ย ย ย ย const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];

ย ย ย ย ย ย ย ย if (currentPlayer) {

ย ย ย ย ย ย ย ย ย ย currentPlayer.questionsAnswered++;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย moveToNextTurn();

ย ย ย ย ย ย }

ย ย ย ย ย ยย

ย ย ย ย ย ย function moveToNextTurn() {

ย ย ย ย ย ย ย ย gameState.turnIndex++;

ย ย ย ย ย ย ย ย const totalTurns = gameState.activePlayers.length * gameState.questionsPerRound;



ย ย ย ย ย ย ย ย if (gameState.turnIndex >= totalTurns) {

ย ย ย ย ย ย ย ย ย ย setTimeout(endRound, 300);

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย setTimeout(prepareTurn, 300);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }



ย ย ย ย ย ย function endRound() {

ย ย ย ย ย ย ย ย stopTimer();

ย ย ย ย ย ย ย ย const sortedPlayers = [...gameState.activePlayers].sort((a, b) => b.score - a.score);

ย ย ย ย ย ย ย ย const highestScore = sortedPlayers.length > 0 ? sortedPlayers[0].score : 0;

ย ย ย ย ย ย ย ย const tiedPlayers = sortedPlayers.filter(p => p.score === highestScore);

ย ย ย ย ย ย ย ย roundScores.innerHTML = '';

ย ย ย ย ย ย ย ย sortedPlayers.forEach(p => {

ย ย ย ย ย ย ย ย ย ย const li = document.createElement('li');

ย ย ย ย ย ย ย ย ย ย li.className = `flex justify-between items-center p-3 rounded-lg ${p.score === highestScore ? 'bg-amber-100 font-bold' : 'bg-gray-100'}`;

ย ย ย ย ย ย ย ย ย ย li.innerHTML = `<span>${p.name}</span><span>${p.score} ููุทุฉ</span>`;

ย ย ย ย ย ย ย ย ย ย roundScores.appendChild(li);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย if (tiedPlayers.length === 1) {

ย ย ย ย ย ย ย ย ย ย winnerName.textContent = tiedPlayers[0].name;

ย ย ย ย ย ย ย ย ย ย showView('winner');

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย roundEndTitle.textContent = "ูุณุฑ ุงูุชุนุงุฏู!";

ย ย ย ย ย ย ย ย ย ย nextActionBtn.textContent = "ุงุจุฏุฃ ุฌููุฉ ูุณุฑ ุงูุชุนุงุฏู";

ย ย ย ย ย ย ย ย ย ย nextActionBtn.onclick = () => startTieBreaker(tiedPlayers);

ย ย ย ย ย ย ย ย ย ย showView('roundEnd');

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }



ย ย ย ย ย ย function startTieBreaker(tiedPlayers) {

ย ย ย ย ย ย ย ย gameState.activePlayers = tiedPlayers;

ย ย ย ย ย ย ย ย gameState.activePlayers.forEach(p => { p.score = 0; p.questionsAnswered = 0; });

ย ย ย ย ย ย ย ย gameState.isTieBreaker = true;

ย ย ย ย ย ย ย ย gameState.questionsPerRound = 5;

ย ย ย ย ย ย ย ย gameState.turnIndex = 0;

ย ย ย ย ย ย ย ย prepareTurn();

ย ย ย ย ย ย }

ย ย ย ย ย ยย

ย ย ย ย ย ย async function analyzePerformance() {

ย ย ย ย ย ย ย ย loadingText.textContent = 'ุฌุงุฑู ุชุญููู ุฃุฏุงุฆู...';

ย ย ย ย ย ย ย ย loadingOverlay.classList.remove('hidden');



ย ย ย ย ย ย ย ย const winner = gameState.activePlayers.find(p => p.name === winnerName.textContent);

ย ย ย ย ย ย ย ย const categories = gameState.selectedCategories.join(', ');

ย ย ย ย ย ย ย ย const prompt = `A quiz player named "${winner.name}" has just won a game. The game categories were: ${categories}. Write a short, fun, and encouraging performance analysis for them in Arabic. Congratulate them, mention they are a master of the chosen topics, and give them one interesting and surprising fun fact related to one of the categories.`;

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

ย ย ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย ย ย const apiKey = ""; // Left empty

ย ย ย ย ย ย ย ย ย ย const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

ย ย ย ย ย ย ย ย ย ย const response = await fetch(apiUrl, {

ย ย ย ย ย ย ย ย ย ย ย ย method: 'POST',

ย ย ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },

ย ย ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(payload)

ย ย ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย ย ย const result = await response.json();

ย ย ย ย ย ย ย ย ย ย let analysisText = "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุฃุฏุงุก. ุญุงูู ูุฑุฉ ุฃุฎุฑู!";

ย ย ย ย ย ย ย ย ย ย if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {

ย ย ย ย ย ย ย ย ย ย ย ย analysisText = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย analysisContent.innerHTML = analysisText;



ย ย ย ย ย ย ย ย } catch (error) {

ย ย ย ย ย ย ย ย ย ย console.error("Error analyzing performance:", error);

ย ย ย ย ย ย ย ย ย ย analysisContent.textContent = "ูุง ูููู ุงูุงุชุตุงู ุจุงูุฎุงุฏู ูุชุญููู ุงูุฃุฏุงุก. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช.";

ย ย ย ย ย ย ย ย } finally {

ย ย ย ย ย ย ย ย ย ย loadingOverlay.classList.add('hidden');

ย ย ย ย ย ย ย ย ย ย analysisModal.classList.remove('hidden');

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }





ย ย ย ย ย ย // --- Event Listeners ---

ย ย ย ย ย ย addPlayerBtn.addEventListener('click', addPlayer);

ย ย ย ย ย ย playerNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && addPlayer());

ย ย ย ย ย ย addCategoryBtn.addEventListener('click', () => addCategory(customCategoryInput.value));

ย ย ย ย ย ย customCategoryInput.addEventListener('keypress', (e) => e.key === 'Enter' && addCategory(customCategoryInput.value));

ย ย ย ย ย ยย

ย ย ย ย ย ย startGameBtn.addEventListener('click', startGame);

ย ย ย ย ย ย startTurnBtn.addEventListener('click', () => {

ย ย ย ย ย ย ย ย if (!audioReady) {

ย ย ย ย ย ย ย ย ย ย Tone.start();

ย ย ย ย ย ย ย ย ย ย setupAudio();

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย startTurn();

ย ย ย ย ย ย });

ย ย ย ย ย ย playAgainBtn.addEventListener('click', init);



ย ย ย ย ย ย clearPlayersBtn.addEventListener('click', () => {

ย ย ย ย ย ย ย ย clearPlayersModal.classList.remove('hidden');

ย ย ย ย ย ย });



ย ย ย ย ย ย cancelClearBtn.addEventListener('click', () => {

ย ย ย ย ย ย ย ย clearPlayersModal.classList.add('hidden');

ย ย ย ย ย ย });



ย ย ย ย ย ย confirmClearBtn.addEventListener('click', () => {

ย ย ย ย ย ย ย ย localStorage.removeItem('quizMasterPlayers');

ย ย ย ย ย ย ย ย gameState.players = [];

ย ย ย ย ย ย ย ย renderPlayerList();

ย ย ย ย ย ย ย ย clearPlayersModal.classList.add('hidden');

ย ย ย ย ย ย });

ย ย ย ย ย ยย

ย ย ย ย ย ย analyzePerformanceBtn.addEventListener('click', analyzePerformance);

ย ย ย ย ย ย closeAnalysisBtn.addEventListener('click', () => {

ย ย ย ย ย ย ย ย analysisModal.classList.add('hidden');

ย ย ย ย ย ย });



ย ย ย ย ย ย // --- Initial Load ---

ย ย ย ย ย ย init();

ย ย ย ย });

ย ย </script>



</body>

</html>
