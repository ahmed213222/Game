<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุนุจุฉ ููู ุงููุนูููุงุช</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            overscroll-behavior-y: contain;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
        }
        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #timer-bar-inner {
            transition: width 1s linear;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app" class="container mx-auto p-4 max-w-2xl w-full">

        <!-- ุดุงุดุฉ ุงูุฅุนุฏุงุฏ -->
        <div id="setup-view" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl fade-in">
            <header class="text-center mb-6">
                <h1 class="text-4xl font-bold text-blue-600">ููู ุงููุนูููุงุช</h1>
                <p class="text-gray-500 mt-1">ูุนุจุฉ ุงูุฐูุงุก ูุงููุนุฑูุฉ ุงูุนุงูุฉ</p>
            </header>

            <div class="mb-6">
                 <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-gray-700">ุฃุถู ุงููุงุนุจูู</h2>
                    <button id="clear-players-btn" class="text-sm text-red-500 hover:underline">ูุณุญ ูู ุงููุงุนุจูู</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="player-name-input" placeholder="ุฃุฏุฎู ุงุณู ุงููุงุนุจ" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500 transition">
                    <button id="add-player-btn" class="bg-blue-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-600 transition shadow">ุฅุถุงูุฉ</button>
                </div>
                <ul id="player-list" class="list-none p-0 mt-3 space-y-2"></ul>
            </div>
            
            <div class="mb-8">
                <h2 class="text-xl font-bold mb-3 text-gray-700">ุงุฎุชุฑ ุงููุฆุงุช</h2>
                <div id="category-selection" class="grid grid-cols-2 gap-3">
                    <!-- Categories will be added here by JS -->
                </div>
            </div>

            <button id="start-game-btn" class="w-full bg-teal-500 text-white font-black py-4 px-8 rounded-lg hover:bg-teal-600 transition shadow-lg text-2xl disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>ุงุจุฏุฃ ุงููุนุจุฉ</button>
        </div>

        <!-- ุดุงุดุฉ ุชูุฑูุฑ ุงููุงุชู -->
        <div id="pass-phone-view" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <h2 id="pass-to-player-name" class="text-3xl font-bold text-gray-800 mb-2"></h2>
            <p id="pass-info" class="text-lg text-gray-600 mb-6"></p>
            <button id="start-turn-btn" class="w-full bg-teal-500 text-white font-bold py-4 px-8 rounded-lg hover:bg-teal-600 transition shadow-lg text-2xl">ุฃูุง ุฌุงูุฒ!</button>
        </div>

        <!-- ุดุงุดุฉ ุงููุนุจ (ุงูุฃุณุฆูุฉ) -->
        <div id="game-view" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-xl fade-in">
            <div class="flex justify-between items-center mb-2 text-gray-600 font-bold">
                <div id="player-turn-name"></div>
                <div id="question-counter"></div>
            </div>
            <div id="timer-bar" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="timer-bar-inner" class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>
            </div>
            <div class="bg-gray-100 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
                <h2 id="question-text" class="text-2xl text-center font-semibold"></h2>
            </div>
            <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Options will be injected here -->
            </div>
        </div>

        <!-- ุดุงุดุฉ ููุงูุฉ ุงูุฌููุฉ / ูุณุฑ ุงูุชุนุงุฏู -->
        <div id="round-end-view" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <h2 id="round-end-title" class="text-3xl font-bold text-blue-600 mb-4"></h2>
            <p class="text-lg text-gray-600 mb-6">ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ ููุฌููุฉ:</p>
            <ul id="round-scores" class="space-y-3 text-lg mb-8">
                <!-- Scores will be injected here -->
            </ul>
            <button id="next-action-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 transition shadow-lg text-xl"></button>
        </div>
        
        <!-- ุดุงุดุฉ ุงููุงุฆุฒ ุงูููุงุฆู -->
        <div id="winner-view" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <div class="text-amber-400 text-6xl mb-4">๐</div>
            <h2 class="text-4xl font-black text-amber-500 mb-2">ุงููุงุฆุฒ ูู!</h2>
            <p id="winner-name" class="text-5xl font-bold text-gray-800 mb-8"></p>
            <button id="play-again-btn" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition">ุงูุนุจ ูุฑุฉ ุฃุฎุฑู</button>
        </div>

    </div>

    <!-- Modal for clearing players -->
    <div id="clear-players-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl shadow-xl text-center max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">ูุณุญ ุงููุงุนุจูู</h3>
            <p class="text-gray-600 mb-6">ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ูุณุญ ูุงุฆูุฉ ุงููุงุนุจูู ุงููุญููุธุฉุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-clear-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">ุฅูุบุงุก</button>
                <button id="confirm-clear-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600">ูุนูุ ุงูุณุญ</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ุจูู ุงูุฃุณุฆูุฉ (ููุณ ุงูุจูู ุงูุณุงุจู) ---
            const QUESTIONS = {
                general: { name: "ูุนูููุงุช ุนุงูุฉ", items: [ { q: "ูุง ูู ุนุงุตูุฉ ูุตุฑุ", o: ["ุงููุงูุฑุฉ", "ุงูุฅุณููุฏุฑูุฉ", "ุงูุฌูุฒุฉ", "ุงูุฃูุตุฑ"], a: "ุงููุงูุฑุฉ" }, { q: "ูู ุฑุณู ุงููููุงููุฒุงุ", o: ["ูุงู ุฌูุฎ", "ุจููุงุณู", "ููููุงุฑุฏู ุฏุงููุดู", "ูุงููู ุฃูุฌูู"], a: "ููููุงุฑุฏู ุฏุงููุดู" }, { q: "ูุง ูู ุงูุนููุฉ ุงูุฑุณููุฉ ูููุงุจุงูุ", o: ["ุงูููุงู", "ุงูููู", "ุงูุฏููุงุฑ", "ุงููู"], a: "ุงููู" }, { q: "ูู ุฃู ุฑูุงุถุฉ ููุนุฑู ูุญูุฏ ุนูู ููุงูุ", o: ["ูุฑุฉ ุงููุฏู", "ุงูููุงููุฉ", "ูุฑุฉ ุงูุณูุฉ", "ุงูุชูุณ"], a: "ุงูููุงููุฉ" }, { q: "ูุง ูู ุงูุฏููุฉ ุงูุชู ุชุดุชูุฑ ุจุจุฑุฌ ุฅูููุ", o: ["ุฅูุทุงููุง", "ุฅุณุจุงููุง", "ูุฑูุณุง", "ุฃููุงููุง"], a: "ูุฑูุณุง" }, { q: "ูุง ูู ุงููุบุฉ ุงูุฃูุซุฑ ุชุญุฏุซูุง ูู ุงูุนุงููุ", o: ["ุงูุฅูุฌููุฒูุฉ", "ุงูุฅุณุจุงููุฉ", "ุงูุตูููุฉ ุงููุงูุฏุฑูู", "ุงูููุฏูุฉ"], a: "ุงูุตูููุฉ ุงููุงูุฏุฑูู" }, { q: "ูุง ูู ุงุณู ุฃูุจุฑ ุตุญุฑุงุก ุญุงุฑุฉ ูู ุงูุนุงููุ", o: ["ุงูุตุญุฑุงุก ุงูุนุฑุจูุฉ", "ุตุญุฑุงุก ุฌูุจู", "ุงูุตุญุฑุงุก ุงููุจุฑู", "ุตุญุฑุงุก ูุงูุงูุงุฑู"], a: "ุงูุตุญุฑุงุก ุงููุจุฑู" }, { q: "ูู ูู ูุฎุชุฑุน ุงููุตุจุงุญ ุงูููุฑุจุงุฆูุ", o: ["ูููููุง ุชูุณูุง", "ุฃููุณูุฏุฑ ุฌุฑุงูุงู ุจูู", "ุชููุงุณ ุฅุฏูุณูู", "ูุงุฑู ููุฑู"], a: "ุชููุงุณ ุฅุฏูุณูู" }, { q: "ูุง ูู ุงูุดุนุงุฑ ุงูุฃูููุจูุ", o: ["ุฃุณุฑุนุ ุฃุนููุ ุฃููู", "ุงููุดุงุฑูุฉ ูู ุงูุฃูู", "ุฑูุญ ุงููุฑูู", "ูุง ุชุณุชุณูู ุฃุจุฏุงู"], a: "ุฃุณุฑุนุ ุฃุนููุ ุฃููู" }, ] },
                science: { name: "ุนููู ูุชูููููุฌูุง", items: [ { q: "ูู ุนุฏุฏ ูุงุฑุงุช ุงูุนุงููุ", o: ["5", "6", "7", "8"], a: "7" }, { q: "ูุง ูู ุฃูุจุฑ ูููุจ ูู ุงููุฌููุนุฉ ุงูุดูุณูุฉุ", o: ["ุงูุฃุฑุถ", "ุงููุฑูุฎ", "ุงููุดุชุฑู", "ุฒุญู"], a: "ุงููุดุชุฑู" }, { q: "ูุง ูู ุงูุฑูุฒ ุงูููููุงุฆู ูููุงุกุ", o: ["H2O", "CO2", "O2", "NaCl"], a: "H2O" }, { q: "ูุง ูู ุฃุณุฑุน ุญููุงู ุจุฑูุ", o: ["ุงูุฃุณุฏ", "ุงูููุฏ", "ุงูุบุฒุงู", "ุงูุญุตุงู"], a: "ุงูููุฏ" }, { q: "ูุง ูู ุงูููุฉ ุงูุชู ุชุฌุฐุจ ุงูุฃุฌุณุงู ูุญู ุจุนุถูุง ุงูุจุนุถุ", o: ["ุงูุงุญุชูุงู", "ุงูุฌุงุฐุจูุฉ", "ุงููุบูุงุทูุณูุฉ", "ุงูููุฑุจุงุก"], a: "ุงูุฌุงุฐุจูุฉ" }, { q: "ูุงุฐุง ูุณูู ุงูุนูู ุงูุฐู ูุฏุฑุณ ุงููุงุฆูุงุช ุงูุญูุฉุ", o: ["ุงูููููุงุก", "ุงูููุฒูุงุก", "ุงูุฃุญูุงุก (ุงูุจููููุฌูุง)", "ุงูููู"], a: "ุงูุฃุญูุงุก (ุงูุจููููุฌูุง)" }, { q: "ูุง ูู ุงูุนูุตุฑ ุงูุฃูุซุฑ ููุฑุฉ ูู ุงูุบูุงู ุงูุฌูู ููุฃุฑุถุ", o: ["ุงูุฃูุณุฌูู", "ุงูููุฏุฑูุฌูู", "ุซุงูู ุฃูุณูุฏ ุงููุฑุจูู", "ุงูููุชุฑูุฌูู"], a: "ุงูููุชุฑูุฌูู" }, { q: "ูุง ูู ุงูุดุฑูุฉ ุงูุชู ุทูุฑุช ูุธุงู ุงูุชุดุบูู 'ูููุฏูุฒ'ุ", o: ["ุขุจู", "ุฌูุฌู", "ูุงููุฑูุณููุช", "ุขู ุจู ุฅู"], a: "ูุงููุฑูุณููุช" }, ] },
                history: { name: "ุชุงุฑูุฎ ูุฌุบุฑุงููุง", items: [ { q: "ูู ูู ุฃูู ุฅูุณุงู ูุดู ุนูู ุณุทุญ ุงูููุฑุ", o: ["ุจุงุฒ ุฃูุฏุฑูู", "ููุฑู ุฌุงุฌุงุฑูู", "ููู ุฃุฑูุณุชุฑููุฌ", "ูุงููู ูููููุฒ"], a: "ููู ุฃุฑูุณุชุฑููุฌ" }, { q: "ูุง ูู ุฃุทูู ููุฑ ูู ุงูุนุงููุ", o: ["ุงูุฃูุงุฒูู", "ุงูููู", "ุงููุณูุณูุจู", "ุงููุงูุบุชุณู"], a: "ุงูููู" }, { q: "ูู ุฃู ูุงุฑุฉ ุชูุน ุฏููุฉ ุงููููุงูุ", o: ["ุขุณูุง", "ุฃูุฑูููุง", "ุฃูุฑูุจุง", "ุฃุณุชุฑุงููุง"], a: "ุฃูุฑูุจุง" }, { q: "ูู ูู ุงููุงุฆุฏ ุงูุฐู ุจูู ุฅูุจุฑุงุทูุฑูุฉ ุงููุบููุ", o: ["ุงูุฅุณููุฏุฑ ุงูุฃูุจุฑ", "ูููููุณ ููุตุฑ", "ุฌูููุฒ ุฎุงู", "ูุงุจูููู ุจููุงุจุฑุช"], a: "ุฌูููุฒ ุฎุงู" }, { q: "ูุง ูู ุงูุญุถุงุฑุฉ ุงูุชู ุจูุช ุงูุฃูุฑุงูุงุช ูู ูุตุฑุ", o: ["ุงูุณููุฑูุฉ", "ุงูุฑููุงููุฉ", "ุงูุฅุบุฑูููุฉ", "ุงููุตุฑูุฉ ุงููุฏููุฉ"], a: "ุงููุตุฑูุฉ ุงููุฏููุฉ" }, { q: "ูุง ูู ุฃูุจุฑ ูุญูุท ูู ุงูุนุงููุ", o: ["ุงูุฃุทูุณู", "ุงูููุฏู", "ุงููุงุฏุฆ", "ุงููุชุฌูุฏ ุงูุดูุงูู"], a: "ุงููุงุฏุฆ" }, ] },
                islamic: { name: "ุฅุณูุงููุงุช", items: [ { q: "ูุง ูู ุฃูู ุณูุฑุฉ ูุฒูุช ูู ุงููุฑุขู ุงููุฑูู ูุงููุฉุ", o: ["ุงูุนูู", "ุงููุงุชุญุฉ", "ุงูุฅุฎูุงุต", "ุงูููุซุฑ"], a: "ุงููุงุชุญุฉ" }, { q: "ูู ูู ุงูุตุญุงุจู ุงูุฐู ููุจ ุจู 'ุณูู ุงููู ุงููุณููู'ุ", o: ["ุนูุฑ ุจู ุงูุฎุทุงุจ", "ุนูู ุจู ุฃุจู ุทุงูุจ", "ุฎุงูุฏ ุจู ุงููููุฏ", "ุฃุจู ุจูุฑ ุงูุตุฏูู"], a: "ุฎุงูุฏ ุจู ุงููููุฏ" }, { q: "ูู ุนุฏุฏ ุฃุฑูุงู ุงูุฅุณูุงูุ", o: ["ุฃุฑุจุนุฉ", "ุฎูุณุฉ", "ุณุชุฉ", "ุณุจุนุฉ"], a: "ุฎูุณุฉ" }, { q: "ูุง ูู ุงูุตูุงุฉ ุงูุชู ุชุตูู ุจุฏูู ุฑููุน ุฃู ุณุฌูุฏุ", o: ["ุตูุงุฉ ุงูุนูุฏ", "ุตูุงุฉ ุงูุฌูุงุฒุฉ", "ุตูุงุฉ ุงูุงุณุชุณูุงุก", "ุตูุงุฉ ุงููุณูู"], a: "ุตูุงุฉ ุงูุฌูุงุฒุฉ" }, { q: "ูู ุฃู ูุฏููุฉ ููุฏ ุงููุจู ูุญูุฏ ุตูู ุงููู ุนููู ูุณููุ", o: ["ุงููุฏููุฉ ุงููููุฑุฉ", "ุงูุทุงุฆู", "ููุฉ ุงูููุฑูุฉ", "ุงููุฏุณ"], a: "ููุฉ ุงูููุฑูุฉ" }, { q: "ูุง ูู ุงุณู ุงูุบุงุฑ ุงูุฐู ูุงู ูุชุนุจุฏ ููู ุงููุจู ูุจู ุงูุจุนุซุฉุ", o: ["ุบุงุฑ ุซูุฑ", "ุบุงุฑ ุญุฑุงุก", "ุบุงุฑ ุฃุญุฏ", "ุบุงุฑ ุจุฏุฑ"], a: "ุบุงุฑ ุญุฑุงุก" }, { q: "ูู ูู ุฃูู ุฒูุฌุงุช ุงููุจู ูุญูุฏ ุตูู ุงููู ุนููู ูุณููุ", o: ["ุนุงุฆุดุฉ ุจูุช ุฃุจู ุจูุฑ", "ุญูุตุฉ ุจูุช ุนูุฑ", "ุฎุฏูุฌุฉ ุจูุช ุฎูููุฏ", "ูุงุฑูุฉ ุงููุจุทูุฉ"], a: "ุฎุฏูุฌุฉ ุจูุช ุฎูููุฏ" }, { q: "ูุง ูู ุงูุดูุฑ ุงูุฐู ูุตูู ููู ุงููุณููููุ", o: ["ุฑุฌุจ", "ุดุนุจุงู", "ุฑูุถุงู", "ุดูุงู"], a: "ุฑูุถุงู" }, ] },
                hard: { name: "ุฃุณุฆูุฉ ุตุนุจุฉ", items: [ { q: "ูู ุฃู ุนุงู ุงูุชูุช ุงูุญุฑุจ ุงูุนุงูููุฉ ุงูุซุงููุฉุ", o: ["1943", "1945", "1947", "1950"], a: "1945" }, { q: "ูุง ูู ุงูุนูุตุฑ ุงูุฐู ููุชูู ุงูุฑูุฒ ุงูููููุงุฆู 'Au'ุ", o: ["ุงููุถุฉ", "ุงูุฐูุจ", "ุงููุญุงุณ", "ุงูุฃููููููู"], a: "ุงูุฐูุจ" }, { q: "ูู ูุชุจ 'ููุฏูุฉ ุงุจู ุฎูุฏูู'ุ", o: ["ุงุจู ุณููุง", "ุงููุงุฑุงุจู", "ุงุจู ุฎูุฏูู", "ุงุจู ุฑุดุฏ"], a: "ุงุจู ุฎูุฏูู" }, { q: "ูู ุนุฏุฏ ุนุธุงู ุฌุณู ุงูุฅูุณุงู ุงูุจุงูุบุ", o: ["206", "212", "300", "198"], a: "206" }, { q: "ูุง ูู ุงูุฏููุฉ ุงูุชู ูุงูุช ุชุนุฑู ุณุงุจููุง ุจุงุณู ุจูุงุฏ ูุงุฑุณุ", o: ["ุงูุนุฑุงู", "ุชุฑููุง", "ุฅูุฑุงู", "ุณูุฑูุง"], a: "ุฅูุฑุงู" }, { q: "ูุง ูู ุฃุนูู ุฎูุฏู ูุญูุทู ูู ุงูุนุงููุ", o: ["ุฎูุฏู ุชููุบุง", "ุฎูุฏู ุงูููุจูู", "ุฎูุฏู ูุฑูุงุฏูู", "ุฎูุฏู ูุงุฑูุงูุง"], a: "ุฎูุฏู ูุงุฑูุงูุง" }, { q: "ูุง ูู ุงูุงุณู ุงูุนููู ูููุชุงููู Cุ", o: ["ุญูุถ ุงูููููู", "ุงูุฑูุชูููู", "ุญูุถ ุงูุฃุณููุฑุจูู", "ุงููุงูุณูููุฑูู"], a: "ุญูุถ ุงูุฃุณููุฑุจูู" }, { q: "ูู ูู ูุฎุฑุฌ ูููู 'Parasite' ุงูุญุงุฆุฒ ุนูู ุฌุงุฆุฒุฉ ุงูุฃูุณูุงุฑุ", o: ["ููููุชู ุชุงุฑุงูุชููู", "ุจููุบ ุฌูู ูู", "ูุงุฑุชู ุณููุฑุณูุฒู", "ูุฑูุณุชููุฑ ูููุงู"], a: "ุจููุบ ุฌูู ูู" }, ] }
            };
            const QUESTION_TIME = 15; // 15 seconds

            // --- ูุชุบูุฑุงุช ุงูุญุงูุฉ ---
            let gameState = {};
            let timerInterval;

            // --- ุงููุคุซุฑุงุช ุงูุตูุชูุฉ ---
            let sounds = {};
            let audioReady = false;

            function setupAudio() {
                sounds.tick = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                sounds.timeUp = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
                sounds.click = new Tone.MembraneSynth().toDestination();
                sounds.nextPlayer = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
                audioReady = true;
            }

            // --- ุนูุงุตุฑ ุงููุงุฌูุฉ ---
            const views = { setup: document.getElementById('setup-view'), passPhone: document.getElementById('pass-phone-view'), game: document.getElementById('game-view'), roundEnd: document.getElementById('round-end-view'), winner: document.getElementById('winner-view') };
            const playerNameInput = document.getElementById('player-name-input');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const playerList = document.getElementById('player-list');
            const categorySelection = document.getElementById('category-selection');
            const startGameBtn = document.getElementById('start-game-btn');
            const passToPlayerName = document.getElementById('pass-to-player-name');
            const passInfo = document.getElementById('pass-info');
            const startTurnBtn = document.getElementById('start-turn-btn');
            const playerTurnName = document.getElementById('player-turn-name');
            const questionCounter = document.getElementById('question-counter');
            const timerBarInner = document.getElementById('timer-bar-inner');
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');
            const roundEndTitle = document.getElementById('round-end-title');
            const roundScores = document.getElementById('round-scores');
            const nextActionBtn = document.getElementById('next-action-btn');
            const winnerName = document.getElementById('winner-name');
            const playAgainBtn = document.getElementById('play-again-btn');
            const clearPlayersModal = document.getElementById('clear-players-modal');
            const clearPlayersBtn = document.getElementById('clear-players-btn');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');

            function init() {
                gameState = { players: [], activePlayers: [], selectedCategories: [], questionPool: [], turnIndex: 0, questionsPerRound: 10, isTieBreaker: false, };
                loadPlayersFromStorage();
                renderPlayerList();
                renderCategories();
                showView('setup');
            }

            function showView(viewName) {
                Object.values(views).forEach(view => view.classList.add('hidden'));
                views[viewName].classList.remove('hidden');
            }
            
            function savePlayersToStorage() {
                const playerNames = gameState.players.map(p => p.name);
                localStorage.setItem('quizMasterPlayers', JSON.stringify(playerNames));
            }

            function loadPlayersFromStorage() {
                const savedPlayers = localStorage.getItem('quizMasterPlayers');
                if (savedPlayers) {
                    const playerNames = JSON.parse(savedPlayers);
                    gameState.players = playerNames.map(name => ({ name, score: 0, questionsAnswered: 0 }));
                }
            }

            function renderPlayerList() {
                playerList.innerHTML = '';
                gameState.players.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-lg';
                    li.textContent = player.name;
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'ร';
                    removeBtn.className = 'text-red-500 font-bold text-2xl hover:text-red-700';
                    removeBtn.onclick = () => removePlayer(index);
                    li.appendChild(removeBtn);
                    playerList.appendChild(li);
                });
                validateSetup();
            }
            
            function renderCategories() {
                categorySelection.innerHTML = '';
                Object.keys(QUESTIONS).forEach(key => {
                    if (key === 'hard') return;
                    const category = QUESTIONS[key];
                    const div = document.createElement('div');
                    div.innerHTML = `<input type="checkbox" id="cat-${key}" value="${key}" class="hidden peer"><label for="cat-${key}" class="block text-center font-bold p-4 border-2 border-gray-300 rounded-lg cursor-pointer transition peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500">${category.name}</label>`;
                    div.querySelector('input').addEventListener('change', handleCategoryChange);
                    categorySelection.appendChild(div);
                });
            }
            
            function handleCategoryChange(event) {
                const { value, checked } = event.target;
                if (checked) {
                    gameState.selectedCategories.push(value);
                } else {
                    gameState.selectedCategories = gameState.selectedCategories.filter(cat => cat !== value);
                }
                validateSetup();
            }

            function validateSetup() {
                startGameBtn.disabled = !(gameState.players.length >= 1 && gameState.selectedCategories.length > 0);
            }

            function addPlayer() {
                const name = playerNameInput.value.trim();
                if (name) {
                    if (gameState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        // This is a simple alert, but for better UX a custom modal would be better.
                        // However, per instructions, avoiding alerts. We can just ignore the add.
                        playerNameInput.value = '';
                        return;
                    }
                    gameState.players.push({ name, score: 0, questionsAnswered: 0 });
                    playerNameInput.value = '';
                    renderPlayerList();
                    savePlayersToStorage();
                }
                playerNameInput.focus();
            }

            function removePlayer(index) {
                gameState.players.splice(index, 1);
                renderPlayerList();
                savePlayersToStorage();
            }

            function startGame() {
                if (!audioReady) setupAudio();
                let basePool = [];
                gameState.selectedCategories.forEach(catKey => { basePool.push(...QUESTIONS[catKey].items); });
                gameState.questionPool = [...basePool].sort(() => 0.5 - Math.random());
                gameState.activePlayers = [...gameState.players];
                gameState.activePlayers.forEach(p => { p.score = 0; p.questionsAnswered = 0; });
                gameState.isTieBreaker = false;
                gameState.questionsPerRound = 10;
                gameState.turnIndex = 0;
                prepareTurn();
            }

            function prepareTurn() {
                if (audioReady) sounds.nextPlayer.triggerAttackRelease("C4", "0.2");
                const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];
                passToPlayerName.textContent = `ุฏูุฑ ${currentPlayer.name}`;
                passInfo.textContent = gameState.isTieBreaker ? `ุงุณุชุนุฏ ูุณุคุงู ูุณุฑ ุงูุชุนุงุฏู!` : `ุงุณุชุนุฏ ูุณุคุงูู ุฑูู ${currentPlayer.questionsAnswered + 1}`;
                showView('passPhone');
            }

            function startTurn() {
                displayQuestion();
                showView('game');
            }

            function displayQuestion() {
                if (gameState.questionPool.length === 0) {
                    let basePool = [];
                    gameState.selectedCategories.forEach(catKey => { basePool.push(...QUESTIONS[catKey].items); });
                    gameState.questionPool = [...basePool].sort(() => 0.5 - Math.random());
                }
                const question = gameState.isTieBreaker ? [...QUESTIONS.hard.items].sort(() => 0.5 - Math.random())[0] : gameState.questionPool.pop();
                gameState.currentQuestion = question;
                const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];
                playerTurnName.textContent = currentPlayer.name;
                questionCounter.textContent = `ุงูุณุคุงู ${currentPlayer.questionsAnswered + 1} / ${gameState.questionsPerRound}`;
                questionText.textContent = question.q;
                optionsContainer.innerHTML = '';
                const shuffledOptions = [...question.o].sort(() => 0.5 - Math.random());
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'option-btn w-full text-lg font-semibold p-4 border-2 border-gray-300 rounded-lg bg-white hover:bg-gray-100';
                    button.onclick = () => handleAnswer(option);
                    optionsContainer.appendChild(button);
                });
                startTimer();
            }

            function startTimer() {
                let timeLeft = QUESTION_TIME;
                timerBarInner.style.width = '100%';
                timerBarInner.classList.remove('bg-red-500');
                timerBarInner.classList.add('bg-blue-600');

                timerInterval = setInterval(() => {
                    timeLeft--;
                    const percentage = (timeLeft / QUESTION_TIME) * 100;
                    timerBarInner.style.width = `${percentage}%`;

                    if (timeLeft <= 5) {
                        timerBarInner.classList.remove('bg-blue-600');
                        timerBarInner.classList.add('bg-red-500');
                        if (audioReady) sounds.tick.triggerAttackRelease("C5", "0.1");
                    }

                    if (timeLeft <= 0) {
                        handleTimeUp();
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function handleAnswer(selectedOption) {
                stopTimer();
                if (audioReady) sounds.click.triggerAttackRelease("C3", "0.1");
                const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];
                if(currentPlayer) {
                    const correctAnswer = gameState.currentQuestion.a;
                    if (selectedOption === correctAnswer) {
                        currentPlayer.score++;
                    }
                    currentPlayer.questionsAnswered++;
                }
                moveToNextTurn();
            }

            function handleTimeUp() {
                stopTimer();
                if (views.game.classList.contains('hidden')) { return; }
                if (audioReady) sounds.timeUp.triggerAttackRelease("A3", "0.3");
                const currentPlayer = gameState.activePlayers[gameState.turnIndex % gameState.activePlayers.length];
                if (currentPlayer) {
                    currentPlayer.questionsAnswered++;
                }
                moveToNextTurn();
            }
            
            function moveToNextTurn() {
                gameState.turnIndex++;
                const totalTurns = gameState.activePlayers.length * gameState.questionsPerRound;

                if (gameState.turnIndex >= totalTurns) {
                    setTimeout(endRound, 300);
                } else {
                    setTimeout(prepareTurn, 300);
                }
            }

            function endRound() {
                stopTimer();
                const sortedPlayers = [...gameState.activePlayers].sort((a, b) => b.score - a.score);
                const highestScore = sortedPlayers.length > 0 ? sortedPlayers[0].score : 0;
                const tiedPlayers = sortedPlayers.filter(p => p.score === highestScore);
                roundScores.innerHTML = '';
                sortedPlayers.forEach(p => {
                    const li = document.createElement('li');
                    li.className = `flex justify-between items-center p-3 rounded-lg ${p.score === highestScore ? 'bg-amber-100 font-bold' : 'bg-gray-100'}`;
                    li.innerHTML = `<span>${p.name}</span><span>${p.score} ููุทุฉ</span>`;
                    roundScores.appendChild(li);
                });
                if (tiedPlayers.length === 1) {
                    winnerName.textContent = tiedPlayers[0].name;
                    showView('winner');
                } else {
                    roundEndTitle.textContent = "ูุณุฑ ุงูุชุนุงุฏู!";
                    nextActionBtn.textContent = "ุงุจุฏุฃ ุฌููุฉ ูุณุฑ ุงูุชุนุงุฏู";
                    nextActionBtn.onclick = () => startTieBreaker(tiedPlayers);
                    showView('roundEnd');
                }
            }

            function startTieBreaker(tiedPlayers) {
                gameState.activePlayers = tiedPlayers;
                gameState.activePlayers.forEach(p => { p.score = 0; p.questionsAnswered = 0; });
                gameState.isTieBreaker = true;
                gameState.questionsPerRound = 5;
                gameState.turnIndex = 0;
                prepareTurn();
            }

            // --- Event Listeners ---
            addPlayerBtn.addEventListener('click', addPlayer);
            playerNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && addPlayer());
            startGameBtn.addEventListener('click', startGame);
            startTurnBtn.addEventListener('click', () => {
                if (!audioReady) {
                    Tone.start();
                    setupAudio();
                }
                startTurn();
            });
            playAgainBtn.addEventListener('click', init);

            clearPlayersBtn.addEventListener('click', () => {
                clearPlayersModal.classList.remove('hidden');
            });

            cancelClearBtn.addEventListener('click', () => {
                clearPlayersModal.classList.add('hidden');
            });

            confirmClearBtn.addEventListener('click', () => {
                localStorage.removeItem('quizMasterPlayers');
                gameState.players = [];
                renderPlayerList();
                clearPlayersModal.classList.add('hidden');
            });

            // --- Initial Load ---
            init();
        });
    </script>

</body>
</html>
